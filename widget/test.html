<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AmpDialer v1 | Admin Console</title>
    <style>
        :root { --primary: #0070f3; --success: #28a745; --error: #dc3545; --bg: #f4f7f9; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 40px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: #333; font-size: 22px; border-bottom: 2px solid var(--bg); padding-bottom: 10px; }
        .section { margin-bottom: 25px; }
        label { display: block; font-size: 12px; text-transform: uppercase; color: #666; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        button { width: 100%; padding: 12px; cursor: pointer; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; transition: opacity 0.2s; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        #status-bar { padding: 12px; border-radius: 6px; font-size: 13px; margin-top: 20px; background: var(--bg); border: 1px solid #eee; min-height: 20px; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 10px; }
        .online { background: #e6f4ea; color: var(--success); }
        .offline { background: #fce8e6; color: var(--error); }
    </style>
</head>
<body>
    <div class="container">
        <h2>AmpDialer Control</h2>

        <div class="section">
            <label>PBX Credentials</label>
            <input type="text" id="user" placeholder="Username (e.g. 101@domain)">
            <input type="password" id="pass" placeholder="Password">
            <button id="login-btn" onclick="runLogin()">Authenticate</button>
        </div>

        <div class="section">
            <label>Outbound Destination</label>
            <input type="text" id="phone" placeholder="17702893113">
            <button id="dial-btn" onclick="runDial()" disabled>Place Call</button>
        </div>

        <div id="status-bar">System Ready.</div>
    </div>

    <script>
        let session = null;

        function updateStatus(msg, type = '') {
            const bar = document.getElementById('status-bar');
            bar.innerText = msg;
            bar.style.color = type === 'error' ? 'var(--error)' : (type === 'success' ? 'var(--success)' : '#333');
        }

        async function runLogin() {
            updateStatus("Authenticating...");
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: document.getElementById('user').value,
                        password: document.getElementById('pass').value
                    })
                });
                const data = await res.json();
                
                if (data.access_token) {
                    session = data;
                    updateStatus("✓ Authenticated. Checking device registration...", "success");
                    await checkRegistration();
                } else {
                    updateStatus("Login Failed: " + (data.error_description || "Invalid Credentials"), "error");
                }
            } catch (e) { updateStatus("Error: " + e.message, "error"); }
        }

        async function checkRegistration() {
            try {
                const res = await fetch('/api/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session })
                });
                const data = await res.json();
                
                if (data.registered) {
                    updateStatus("✓ System Online (Device Registered)", "success");
                    document.getElementById('dial-btn').disabled = false;
                } else {
                    updateStatus("⚠ Warning: No Registered Devices Found", "error");
                    document.getElementById('dial-btn').disabled = false; // Still allow dial for testing
                }
            } catch (e) { console.error("Status check failed", e); }
        }

        async function runDial() {
            updateStatus("Initiating Call...");
            try {
                const res = await fetch('/api/dial', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        toNumber: document.getElementById('phone').value,
                        session: session
                    })
                });
                const data = await res.json();
                updateStatus("Call Triggered: " + (data.message || "OK"), "success");
            } catch (e) { updateStatus("Dial Failed: " + e.message, "error"); }
        }
    </script>
</body>
</html>
