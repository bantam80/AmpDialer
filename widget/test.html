<!DOCTYPE html>
<html>
<head>
    <title>AmpDialer v1 Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        input { padding: 8px; margin: 5px 0; width: 250px; display: block; }
        button { padding: 10px 20px; cursor: pointer; background: #0070f3; color: white; border: none; border-radius: 5px; }
        #status { font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>AmpDialer Control Panel</h2>

    <div class="box">
        <h3>Step 1: Authenticate</h3>
        <input type="text" id="user" placeholder="101@291565">
        <input type="password" id="pass" placeholder="PBX Password">
        <button onclick="testLogin()">Login</button>
    </div>

    <div class="box">
        <h3>Step 2: Execute Dial</h3>
        <input type="text" id="phone" placeholder="17702893113">
        <button onclick="testDial()">Click to Call</button>
    </div>

    <div id="status">Ready</div>

    <script>
        let currentSession = null;

        async function testLogin() {
            const status = document.getElementById('status');
            status.innerText = "Authenticating...";
            
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: document.getElementById('user').value,
                        password: document.getElementById('pass').value
                    })
                });
                
                const data = await res.json();
                if (data.access_token) {
                    currentSession = data;
                    status.innerText = "Login Success! Token acquired.";
                    status.style.color = "green";
                } else {
                    status.innerText = "Login Failed: " + (data.error_description || data.error || "Unknown Error");
                    status.style.color = "red";
                }
            } catch (e) {
                status.innerText = "Network Error: " + e.message;
            }
        }

        async function testDial() {
            if (!currentSession) return alert("Please login first!");
            const status = document.getElementById('status');
            status.innerText = "Initiating Call...";

            try {
                const res = await fetch('/api/dial', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        toNumber: document.getElementById('phone').value,
                        session: currentSession
                    })
                });

                const data = await res.json();
                status.innerText = "Response: " + JSON.stringify(data);
            } catch (e) {
                status.innerText = "Dial Error: " + e.message;
            }
        }
    </script>
</body>
</html>
