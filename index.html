<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmpDialer - Final Validation</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .container { max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 8px; border: 1px solid #ccc; }
        #log { background: #000; color: #0f0; padding: 10px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 11px; margin-bottom: 10px; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background: #3498db; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; }
    </style>
    <script src="sip-0.21.2.min.js"></script>
</head>
<body>
<div class="container">
    <h3>AmpDialer</h3>
    <div id="log">Ready...</div>
    <input type="text" id="dest" placeholder="Number to dial">
    <button id="btnConnect">GO ONLINE</button>
    <button id="btnDial" style="margin-top:5px; background:#2ecc71;" disabled>DIAL</button>
</div>

<script>
    // --- DATA FROM YOUR SOURCE-OF-TRUTH LOGS ---
    const EXT = "101wp";
    const DOMAIN = "291565";
    const AUTH_KEY = "vYHJ9izVcP381d3n";
    const WS_SERVER = "wss://core2-mia.ringlogix.com:9002";
    const UA_STRING = "SNAP.GO Webphone 44.2.2 (Chrome 143.0.0.0)";

    // --- INTERNAL BYPASS DATA ---
    const FAKE_DOMAIN = "simplelogin.net"; // Used to stop SIP.js from crashing
    const SAFE_URI = `sip:${EXT}@${FAKE_DOMAIN}`;
    const REAL_URI = `sip:${EXT}@${DOMAIN}`;

    const logEl = document.getElementById("log");
    const btnConnect = document.getElementById("btnConnect");
    const btnDial = document.getElementById("btnDial");

    function log(m) { logEl.innerHTML += `<div>${m}</div>`; logEl.scrollTop = logEl.scrollHeight; }

    async function start() {
        log("üîÑ Starting Secure Handshake...");
        
        const targetURI = SIP.UserAgent.makeURI(SAFE_URI);

        const userAgent = new SIP.UserAgent({
            transportConstructor: SIP.WebSocketTransport,
            transportOptions: { server: WS_SERVER },
            uri: targetURI,
            authorizationUsername: `sip:${EXT}@${DOMAIN}`, // Matches SNAP.GO trace
            authorizationPassword: AUTH_KEY,
            userAgentString: UA_STRING,
            delegate: {
                onConnect: () => log("üîó WebSocket Connected"),
            }
        });

        // ==========================================
        // üõ°Ô∏è THE INTERCEPTOR (The Key Fix) üõ°Ô∏è
        // ==========================================
        const originalSend = userAgent.transport.send;
        userAgent.transport.send = function(message) {
            // Swap fake domain for real domain in every outgoing packet
            let newMessage = message.replaceAll(FAKE_DOMAIN, DOMAIN);
            
            // Specifically fix the Auth URI if it contains the fake domain
            newMessage = newMessage.replaceAll(`uri="sip:${FAKE_DOMAIN}"`, `uri="sip:${DOMAIN}"`);
            
            return originalSend.apply(this, [newMessage]);
        };

        const originalOnMessage = userAgent.transport.onMessage;
        userAgent.transport.onMessage = function(msg) {
            let data = (typeof msg === 'object' && msg.data) ? msg.data : msg;
            // Swap real domain back to fake so SIP.js library doesn't crash on receipt
            let newData = data.replaceAll(DOMAIN, FAKE_DOMAIN);
            return originalOnMessage.call(this, newData);
        };
        // ==========================================

        try {
            await userAgent.start();
            const registerer = new SIP.Registerer(userAgent, {
                registrar: SIP.UserAgent.makeURI(`sip:${FAKE_DOMAIN}`)
            });

            registerer.stateChange.addListener((state) => {
                if (state === SIP.RegistererState.Registered) {
                    log("‚úÖ REGISTERED & READY");
                    btnConnect.disabled = true;
                    btnDial.disabled = false;
                }
            });

            await registerer.register();
        } catch (e) { log("‚ùå Error: " + e.message); }
    }

    btnConnect.onclick = start;
</script>
</body>
</html>
