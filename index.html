/* =========================================
       CONFIGURATION
       ========================================= */
    const CONFIG = {
        // Point this to your new Render URL
        authProxyUrl: 'https://zoho-auth-proxy.onrender.com/auth/login', 
        
        // This is still needed for the DEVICE lookup (Phase B), 
        // but it's safe because we only hit it AFTER we have a token.
        apiBase: 'https://api.ringlogix.com/ns-api/v2' 
    };

    /* =========================================
       PART 1: AUTHENTICATION (VIA PROXY)
       ========================================= */
    async function handleLogin() {
        const user = document.getElementById('rl-username').value;
        const pass = document.getElementById('rl-password').value;
        const btn = document.querySelector('button');
        const err = document.getElementById('login-error');
        
        btn.innerText = "Authenticating...";
        err.innerText = "";

        try {
            // A. GET TOKEN (Call YOUR Proxy, not RingLogix)
            const authRes = await fetch(CONFIG.authProxyUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, password: pass })
            });

            if (!authRes.ok) throw new Error("Login failed. Check credentials.");
            const authData = await authRes.json();
            
            // B. DISCOVER SIP DETAILS (Client-side is safe now because we have a Token)
            const devicesRes = await fetch(`${CONFIG.apiBase}/domains/users/phones`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${authData.access_token}` }
            });
            
            const devices = await devicesRes.json();
            const phone = devices.find(d => d.sip_username && d.sip_password);
            
            if (!phone) throw new Error("No SIP Phone found for this user.");

            // C. SUCCESS
            console.log("SIP Credentials Found:", phone.sip_username);
            initializeSoftphone(phone.sip_username, phone.sip_password, phone.domain);
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dialer-screen').classList.remove('hidden');
            renderLeads();

        } catch (e) {
            console.error(e);
            err.innerText = e.message;
            btn.innerText = "Login & Initialize";
        }
    }
