<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hammer Console - SIP Dialer</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; font-size: 16px; margin-right: 10px; }
        #btn-connect { background-color: #007bff; color: white; }
        #btn-connect:disabled { background-color: #ccc; }
        #btn-dial { background-color: #28a745; color: white; }
        #btn-hangup { background-color: #dc3545; color: white; }
        #output { margin-top: 20px; padding: 10px; background: #222; color: #0f0; height: 300px; overflow-y: auto; font-family: monospace; border-radius: 4px; }
        .status-bar { margin-bottom: 20px; padding: 10px; background: #e9ecef; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Hammer Console (WebPhone)</h2>

    <div class="status-bar">
        <div class="input-group">
            <label>Login ID (Extension@Domain)</label>
            <input type="text" id="rl-username" placeholder="e.g. 101@291565" value="101@291565">
        </div>
        <div class="input-group">
            <label>Password</label>
            <input type="password" id="rl-password" placeholder="SIP Password">
        </div>
        <button id="btn-connect">Step 1: Connect & Register</button>
    </div>

    <hr>

    <div class="input-group">
        <label>Destination Number</label>
        <input type="text" id="dest-number" placeholder="1234567890">
    </div>
    
    <div>
        <button id="btn-dial">Step 2: Dial</button>
        <button id="btn-hangup">Hangup</button>
    </div>

    <div id="output"></div>
    
    <audio id="remoteAudio" autoplay></audio>
</div>

<script src="sip-0.21.2.min.js"></script>

<script>
    // ============================================================
    // CONFIGURATION & GLOBAL VARIABLES
    // ============================================================
    // The WebSocket server found in your logs
    const WS_SERVER = "wss://core2-mia.ringlogix.com:9002"; 

    // UI References
    const outputDiv = document.getElementById("output");
    const btnConnect = document.getElementById("btn-connect");
    const btnDial = document.getElementById("btn-dial");
    const btnHangup = document.getElementById("btn-hangup");
    const inputLogin = document.getElementById("rl-username");
    const inputPassword = document.getElementById("rl-password");
    const inputDest = document.getElementById("dest-number");
    const remoteAudio = document.getElementById("remoteAudio");

    let userAgent = null;
    let currentSession = null;

    // ============================================================
    // LOGGING HELPER
    // ============================================================
    function log(msg, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const el = document.createElement("div");
        el.innerText = `[${timestamp}] ${msg}`;
        
        if (type === "error") el.style.color = "#ff4d4d"; // Red
        if (type === "success") el.style.color = "#4dff4d"; // Green
        
        outputDiv.appendChild(el);
        outputDiv.scrollTop = outputDiv.scrollHeight; // Auto-scroll
        console.log(msg);
    }

    // ============================================================
    // STEP 1: DYNAMIC CONNECTION (FIXED)
    // ============================================================
    async function connectToPBX() {
        const loginStr = inputLogin.value.trim(); 
        const password = inputPassword.value.trim();

        if (!loginStr || !password) {
            log("‚ùå Please enter Login ID and Password.", "error");
            return;
        }

        // 1. CLEAN & PARSE
        const parts = loginStr.split('@');
        if (parts.length !== 2) {
            log("‚ùå Invalid Login Format. Must be: Ext@Domain", "error");
            return;
        }

        // AGGRESSIVE TRIMMING (Fixes "Failed to create URI" caused by spaces)
        const userExt = parts[0].trim();       
        const tenantDomain = parts[1].trim();  
        
        // 2. CONSTRUCT IDENTITY
        const deviceUser = `${userExt}wp`; // Adds "wp" suffix
        
        log(`üîπ Parsing: User='${userExt}', Domain='${tenantDomain}'`);

        // 3. GENERATE URI (With Error Catching)
        // We try the Tenant Domain first (e.g. 291565)
        let uriString = `sip:${deviceUser}@${tenantDomain}`;
        let mySipUri = SIP.UserAgent.makeURI(uriString);

        // Fallback: If parser rejects "291565", try the main domain
        if (!mySipUri) {
            log(`‚ö†Ô∏è Parser rejected '${uriString}'. Trying fallback domain...`, "error");
            uriString = `sip:${deviceUser}@ringlogix.com`; // Fallback
            mySipUri = SIP.UserAgent.makeURI(uriString);
        }

        if (!mySipUri) {
            log(`‚ùå CRITICAL: Could not generate URI from '${uriString}'`, "error");
            return;
        }

        log(`üöÄ Identity Created: ${mySipUri.toString()}`);

        // 4. CONFIGURATION
        userAgent = new SIP.UserAgent({
            uri: mySipUri,
            displayName: "Hammer Console",
            
            // Credentials
            authorizationUsername: deviceUser, 
            authorizationPassword: password,

            // Server
            transportOptions: {
                server: WS_SERVER
            },
            
            register: true, 
            contactName: deviceUser,
            // Debug Mode: see exactly why SIP.js might be unhappy in the browser console
            logLevel: "debug" 
        });

        setupEventHandlers();

        try {
            await userAgent.start();
            log("‚úÖ SIP Agent Started. Connecting...", "success");
        } catch (err) {
            log(`‚ùå Error starting SIP Agent: ${err}`, "error");
        }
    }

    // ============================================================
    // EVENT HANDLERS
    // ============================================================
    function setupEventHandlers() {
        // WebSocket State
        userAgent.transport.on("connected", () => {
            log("‚úÖ WebSocket Connected!", "success");
        });
        
        userAgent.transport.on("disconnected", () => {
            log("‚ö†Ô∏è WebSocket Disconnected", "error");
            btnConnect.disabled = false;
            btnConnect.innerText = "Step 1: Connect & Register";
        });

        // Registration State
        userAgent.on("registered", () => {
            log("‚úÖ Registered! Ready to make calls.", "success");
            btnConnect.disabled = true;
            btnConnect.innerText = "Connected";
        });

        userAgent.on("registrationFailed", (response) => {
            log(`‚ùå Registration Failed: ${response.cause}`, "error");
        });

        // Incoming Call Handling
        userAgent.on("invite", (invitation) => {
            log("üìû Incoming Call...");
            currentSession = invitation;
            
            // Auto-accept for testing (or add a button to accept)
            // invitation.accept(); 
            
            // Handle cleanup when call ends
            invitation.stateChange.addListener((state) => {
                if (state === SIP.SessionState.Terminated) {
                    log("Call Ended");
                    currentSession = null;
                }
            });
        });
    }

    // ============================================================
    // STEP 2: DIALING
    // ============================================================
    async function makeCall() {
        if (!userAgent || !userAgent.transport.isConnected()) {
            log("‚ùå Error: Not Connected.", "error");
            return;
        }

        const dest = inputDest.value.trim();
        if (!dest) {
            log("‚ùå Error: Enter a destination number.", "error");
            return;
        }

        log(`üìû Dialing ${dest}...`);

        // Create target URI. We can use the WS_SERVER domain or the Login domain.
        // Usually, the server handles routing just fine if we send sip:NUMBER@DOMAIN
        // We use the tenant domain parsed from the login input.
        const tenantDomain = inputLogin.value.split('@')[1];
        const target = SIP.UserAgent.makeURI(`sip:${dest}@${tenantDomain}`);

        const inviter = new SIP.Inviter(userAgent, target, {
            sessionDescriptionHandlerOptions: {
                constraints: { audio: true, video: false }
            }
        });

        currentSession = inviter;

        // Monitor Call State
        inviter.stateChange.addListener((state) => {
            log(`Call State: ${state}`);
            
            switch (state) {
                case SIP.SessionState.Establishing:
                    log("üîî Ringing...");
                    break;
                case SIP.SessionState.Established:
                    log("üó£Ô∏è Call Connected!", "success");
                    setupRemoteMedia(inviter);
                    break;
                case SIP.SessionState.Terminated:
                    log("Call Ended");
                    currentSession = null;
                    break;
            }
        });

        // Send the Invite
        inviter.invite()
            .then(() => log("Invite Sent"))
            .catch((e) => log(`‚ùå Invite Failed: ${e}`, "error"));
    }

    // ============================================================
    // MEDIA & HANGUP
    // ============================================================
    function setupRemoteMedia(session) {
        const remoteStream = new MediaStream();
        session.sessionDescriptionHandler.peerConnection.getReceivers().forEach((receiver) => {
            if (receiver.track) {
                remoteStream.addTrack(receiver.track);
            }
        });
        remoteAudio.srcObject = remoteStream;
        remoteAudio.play().catch(e => log("‚ö†Ô∏è Audio Play Error: Click the page to allow audio."));
    }

    function hangupCall() {
        if (!currentSession) return;

        if (currentSession.state === SIP.SessionState.Established) {
            currentSession.bye();
        } else if (currentSession.state === SIP.SessionState.Establishing) {
            currentSession.cancel();
        }
        currentSession = null;
        log("Hangup requested.");
    }

    // Listeners
    btnConnect.addEventListener("click", connectToPBX);
    btnDial.addEventListener("click", makeCall);
    btnHangup.addEventListener("click", hangupCall);

</script>
</body>
</html>
