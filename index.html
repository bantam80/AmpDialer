/* THE PRODUCTION APPROACH
   No "Hacking" required. Users use their normal portal login.
*/

// 1. CONSTANTS (From your RingLogix Partner Portal)
const API_CONFIG = {
    baseUrl: 'https://api.ringlogix.com/ns-api/v2', // Verify your regional API URL
    clientId: 'YOUR_PARTNER_ID', 
    clientSecret: 'YOUR_PARTNER_SECRET' 
};

// 2. THE LOGIN FUNCTION (Trades User/Pass for SIP Creds)
async function loginAndGetSipDetails(username, password) {
    try {
        console.log("üîÑ Authenticating...");

        // Step A: Get Access Token (OAuth2)
        // This confirms they are a real user and gets us a "Key" to ask for more info
        const authResponse = await fetch(`${API_CONFIG.baseUrl}/oauth2/token`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                'grant_type': 'password',
                'client_id': API_CONFIG.clientId,
                'client_secret': API_CONFIG.clientSecret,
                'username': username,
                'password': password
            })
        });

        if (!authResponse.ok) throw new Error("Login Failed");
        const tokens = await authResponse.json();
        const accessToken = tokens.access_token;

        // Step B: Get Device Details (The "Hidden" SIP Info)
        // We ask the API: "What is the SIP password for this user's phone?"
        const deviceResponse = await fetch(`${API_CONFIG.baseUrl}/domains/users/devices`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });

        const devices = await deviceResponse.json();
        
        // We grab the first active device found for this user
        const myDevice = devices.find(d => d.mac || d.sip_username); 

        return {
            sipUri: `sip:${myDevice.sip_username}@${myDevice.domain}`,
            sipPassword: myDevice.sip_password, // The Gold! üèÜ
            websocketUrl: `wss://${myDevice.domain}:8089` // Or standard RingLogix WSS
        };

    } catch (error) {
        console.error("Auth Error:", error);
        alert("Login failed. Check console.");
        return null;
    }
}

// 3. USAGE (Connects to the UI)
async function handleLoginBtnClick() {
    const user = document.getElementById('username_input').value;
    const pass = document.getElementById('password_input').value;

    const sipConfig = await loginAndGetSipDetails(user, pass);

    if (sipConfig) {
        // Pass these dynamic creds into your generic SIP.js function
        initializeSoftphone(sipConfig); 
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('dialer-screen').style.display = 'block';
    }
}
