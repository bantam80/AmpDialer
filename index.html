<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zoho Power Dialer</title>
    
    <script src="sip-0.21.2.min.js"></script>
    
    <script src="https://live.zwidgets.com/js-sdk/1.1/ZohoEmbededAppSDK.min.js"></script>
    
    <style>
        :root { --primary: #007bff; --success: #28a745; --bg: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); max-width: 400px; margin: 0 auto; }
        .hidden { display: none !important; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;}
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        .status-bar { text-align: center; margin-bottom: 15px; font-size: 0.9em; color: #666; }
        .led { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-right: 5px; }
        .led.on { background: var(--success); }
        .lead-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .lead-row.active { background: #e3f2fd; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>

    <div id="login-screen" class="card">
        <h2 style="text-align:center;">ðŸ”Œ Connect Phone</h2>
        <div id="login-error" style="color:red; font-size:0.8em; text-align:center;"></div>
        <input type="text" id="rl-username" placeholder="RingLogix Username (user@domain.com)">
        <input type="password" id="rl-password" placeholder="Password">
        <button onclick="handleLogin()">Login & Initialize</button>
    </div>

    <div id="dialer-screen" class="card hidden">
        <div class="status-bar"><span id="sip-led" class="led"></span> <span id="sip-status">Connecting...</span></div>
        
        <div id="leads-list">
            </div>

        <div style="margin-top:20px; display:flex; gap:10px;">
            <button onclick="startPowerDialer()" style="background:var(--success)">Start Dialing</button>
            <button onclick="stopPowerDialer()" style="background:#dc3545">Stop</button>
        </div>
        
        <div style="margin-top:10px;">
            <input type="text" id="manual-dial" placeholder="Or enter number manually...">
            <button onclick="manualCall()" style="background:#6c757d; margin-top:0;">Call</button>
        </div>
    </div>

<script>
    /* =========================================
       CONFIGURATION
       ========================================= */
    const CONFIG = {
        authProxyUrl: 'https://ampdialer.onrender.com/auth/login', 
        apiBase: 'https://pbx.simplelogin.net/ns-api/v2' 
    };

    let userAgent; 
    let isDialing = false;

    // Mock Leads
    const leads = [
        { Name: 'Bartow Industries', Phone: '17705550101' },
        { Name: 'Cartersville Paving', Phone: '17705550102' }
    ];

    /* =========================================
       PART 1: AUTHENTICATION
       ========================================= */
    async function handleLogin() {
        if (typeof SIP === 'undefined') {
            alert("Error: SIP.js library not loaded. Check filename in index.html");
            return;
        }

        const fullUsername = document.getElementById('rl-username').value.trim();
        const pass = document.getElementById('rl-password').value;
        const btn = document.querySelector('button');
        const err = document.getElementById('login-error');
        
        btn.innerText = "Authenticating...";
        err.innerText = "";

        if (!fullUsername.includes('@')) {
            err.innerText = "Please use full format: user@domain.com";
            btn.innerText = "Login & Initialize";
            return;
        }
        const [userPart, domainPart] = fullUsername.split('@');

        try {
            // A. GET TOKEN
            console.log("Step A: Requesting Token...");
            const authRes = await fetch(CONFIG.authProxyUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: fullUsername, password: pass })
            });

            if (!authRes.ok) throw new Error("Login failed. Check credentials.");
            const authData = await authRes.json();
            
            // B. DISCOVER DEVICES
            console.log("Step B: Looking up Devices...");
            const explicitUrl = `${CONFIG.apiBase}/domains/${domainPart}/users/${userPart}/devices`;
            
            const devicesRes = await fetch(explicitUrl, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${authData.access_token}` }
            });

            if (!devicesRes.ok) throw new Error(`Phone Lookup Failed (${devicesRes.status})`);
            
            let devices = await devicesRes.json();
            if (!Array.isArray(devices)) devices = [devices];

            // C. FIND MATCHING DEVICE
            let targetDevice = devices.find(d => d['device-sip-registration-password']);
            
            if (!targetDevice) {
                console.warn("No device with registration password found, checking fallback...");
                targetDevice = devices[0];
            }

            if (!targetDevice) throw new Error("No SIP devices found.");

            // D. EXTRACT CREDENTIALS
            const sipUser = targetDevice.device; 
            const sipPass = targetDevice['device-sip-registration-password'];
            
            if (!sipUser || !sipPass) {
                console.error("Device Data:", targetDevice);
                throw new Error("Device found, but missing credentials.");
            }

            // E. INITIALIZE
            console.log(`Initializing SIP: ${sipUser} @ ${domainPart}`);
            initializeSoftphone(sipUser, sipPass, domainPart);
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dialer-screen').classList.remove('hidden');
            renderLeads();

        } catch (e) {
            console.error(e);
            err.innerText = e.message;
            btn.innerText = "Login & Initialize";
        }
    }

    /* =========================================
       PART 2: SIP.JS (THE SOFTPHONE)
       ========================================= */
    function initializeSoftphone(sipUser, sipPass, domain) {
        // Extract Hostname (e.g., pbx.simplelogin.net)
        const pbxHost = new URL(CONFIG.apiBase).hostname;

        const transportOptions = {
            // ðŸ‘‡ CHANGE THIS: Use Port 443 (Standard HTTPS)
            server: `wss://${pbxHost}:443` 
        };

        console.log(`ðŸ”Œ Connecting to WebSocket: ${transportOptions.server}`);

        const uri = SIP.UserAgent.makeURI(`sip:${sipUser}@${domain}`);
        
        userAgent = new SIP.UserAgent({
            uri: uri,
            transportOptions: transportOptions,
            authorizationUsername: sipUser,
            authorizationPassword: sipPass,
            // Add a keepalive to prevent timeouts
            hackViaTcp: true, 
            delegate: {
                onConnect: () => {
                    console.log("âœ… SIP Connected!");
                    document.getElementById('sip-led').classList.add('on');
                    document.getElementById('sip-status').innerText = "Phone Ready";
                },
                onDisconnect: (error) => {
                    console.warn("âŒ SIP Disconnected:", error);
                    document.getElementById('sip-led').classList.remove('on');
                    document.getElementById('sip-status').innerText = "Disconnected";
                    
                    // Optional: Retry logic could go here
                    if (error && error.code === 1006) {
                         document.getElementById('sip-status').innerText = "Connection Blocked (Firewall?)";
                    }
                }
            }
        });

        userAgent.start()
            .then(() => console.log("User Agent Started"))
            .catch(e => console.error("User Agent Failed:", e));
    }

    /* =========================================
       PART 3: DIALER LOGIC
       ========================================= */
    function renderLeads() {
        const list = document.getElementById('leads-list');
        list.innerHTML = leads.map((l, i) => 
            `<div class="lead-row" id="row-${i}">
                <span>${l.Name}</span>
                <small>${l.Phone}</small>
             </div>`
        ).join('');
    }

    async function startPowerDialer() {
        isDialing = true;
        for (let i = 0; i < leads.length; i++) {
            if (!isDialing) break;
            
            document.querySelectorAll('.lead-row').forEach(r => r.classList.remove('active'));
            document.getElementById(`row-${i}`).classList.add('active');
            
            await placeCall(leads[i].Phone);
            await new Promise(r => setTimeout(r, 5000));
        }
    }

    function stopPowerDialer() { isDialing = false; }

    async function manualCall() {
        const num = document.getElementById('manual-dial').value;
        if(num) placeCall(num);
    }

    function placeCall(number) {
        return new Promise((resolve) => {
            if (!userAgent) { alert("Phone not initialized!"); return; }

            console.log("Dialing:", number);
            document.getElementById('sip-status').innerText = `Dialing ${number}...`;
            
            const target = SIP.UserAgent.makeURI(`sip:${number}@${userAgent.configuration.uri.host}`);
            if (!target) { console.error("Invalid URI"); return; }

            const inviter = new SIP.Inviter(userAgent, target);
            
            inviter.stateChange.addListener((state) => {
                console.log("Call State:", state);
                if (state === SIP.SessionState.Terminated) {
                    document.getElementById('sip-status').innerText = "Call Ended";
                    resolve(); 
                }
            });

            inviter.invite()
                .then(() => console.log("Invite Sent"))
                .catch((e) => {
                    console.error("Invite Failed", e);
                    document.getElementById('sip-status').innerText = "Call Failed";
                });
        });
    }

    ZOHO.embeddedApp.init();
</script>
</body>
</html>
