<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zoho Power Dialer</title>
    <script src="https://live.zwidgets.com/js-sdk/1.1/ZohoEmbededAppSDK.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sip.js/0.21.2/sip.min.js"></script>
    
    <style>
        :root { --primary: #007bff; --success: #28a745; --bg: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); max-width: 400px; margin: 0 auto; }
        .hidden { display: none !important; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;}
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        .status-bar { text-align: center; margin-bottom: 15px; font-size: 0.9em; color: #666; }
        .led { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-right: 5px; }
        .led.on { background: var(--success); }
        .lead-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .lead-row.active { background: #e3f2fd; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>

    <div id="login-screen" class="card">
        <h2 style="text-align:center;">ðŸ”Œ Connect Phone</h2>
        <div id="login-error" style="color:red; font-size:0.8em; text-align:center;"></div>
        <input type="text" id="rl-username" placeholder="RingLogix Username (user@domain.com)">
        <input type="password" id="rl-password" placeholder="Password">
        <button onclick="handleLogin()">Login & Initialize</button>
    </div>

    <div id="dialer-screen" class="card hidden">
        <div class="status-bar"><span id="sip-led" class="led"></span> <span id="sip-status">Connecting...</span></div>
        
        <div id="leads-list">
            </div>

        <div style="margin-top:20px; display:flex; gap:10px;">
            <button onclick="startPowerDialer()" style="background:var(--success)">Start Dialing</button>
            <button onclick="stopPowerDialer()" style="background:#dc3545">Stop</button>
        </div>
        
        <div style="margin-top:10px;">
            <input type="text" id="manual-dial" placeholder="Or enter number manually...">
            <button onclick="manualCall()" style="background:#6c757d; margin-top:0;">Call</button>
        </div>
    </div>

<script>
    /* =========================================
       CONFIGURATION
       ========================================= */
    const CONFIG = {
        // Your Python Proxy on Render
        authProxyUrl: 'https://ampdialer.onrender.com/auth/login', 
        
        // Your Specific PBX Cluster (Must include /v2 for frontend lookup)
        apiBase: 'https://pbx.simplelogin.net/ns-api/v2' 
    };

    let userAgent; 
    let isDialing = false;

    // Zoho Mock Data
    const leads = [
        { Name: 'Bartow Industries', Phone: '17705550101' },
        { Name: 'Cartersville Paving', Phone: '17705550102' }
    ];

    /* =========================================
       PART 1: AUTHENTICATION (Debug Mode)
       ========================================= */
    async function handleLogin() {
        const fullUsername = document.getElementById('rl-username').value.trim();
        const pass = document.getElementById('rl-password').value;
        const btn = document.querySelector('button');
        const err = document.getElementById('login-error');
        
        btn.innerText = "Authenticating...";
        err.innerText = "";

        if (!fullUsername.includes('@')) {
            err.innerText = "Please use full format: user@domain.com";
            btn.innerText = "Login & Initialize";
            return;
        }
        const [userPart, domainPart] = fullUsername.split('@');

        try {
            // A. GET TOKEN
            console.log("Step A: Requesting Token...");
            const authRes = await fetch(CONFIG.authProxyUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: fullUsername, password: pass })
            });

            if (!authRes.ok) throw new Error("Login failed. Check credentials.");
            const authData = await authRes.json();
            
            // B. DISCOVER DEVICE
            console.log("Step B: Looking up Devices...");
            const explicitUrl = `${CONFIG.apiBase}/domains/${domainPart}/users/${userPart}/devices`;
            
            const devicesRes = await fetch(explicitUrl, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${authData.access_token}` }
            });

            if (!devicesRes.ok) throw new Error(`Phone Lookup Failed (${devicesRes.status})`);
            
            let devices = await devicesRes.json();
            if (!Array.isArray(devices)) devices = [devices];

            // ðŸ” DEBUG: Print the exact structure the API is returning
            console.log("--- DEBUG: RAW DEVICE DATA ---");
            console.log(JSON.stringify(devices, null, 2)); 
            console.log("------------------------------");

            // C. SELECT DEVICE
            // We prioritize 'wp' but take anything available
            let targetDevice = devices.find(d => d.device && d.device.includes('wp@'));
            if (!targetDevice) {
                console.log("'wp' device not found, using first available device.");
                targetDevice = devices[0];
            }

            if (!targetDevice) throw new Error("No SIP devices found for this user.");

            // D. PARSE USERNAME (Updated to check more fields)
            // We check every possible variation of "username"
            let sipUser = targetDevice.sip_username || 
                          targetDevice.username || 
                          targetDevice.aor || 
                          targetDevice.subscriber_name;

            // Fallback: Parse from 'device' string (e.g. sip:101wp@domain)
            if (!sipUser && targetDevice.device) {
                const match = targetDevice.device.match(/sip:(.*?)@/);
                if (match) sipUser = match[1];
            }

            if (!sipUser) throw new Error("Could not determine SIP Username. Check Console Logs.");

            // E. INITIALIZE
            console.log(`Initializing SIP with User: ${sipUser} @ ${domainPart}`);
            initializeSoftphone(sipUser, pass, domainPart);
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dialer-screen').classList.remove('hidden');
            renderLeads();

        } catch (e) {
            console.error(e);
            err.innerText = e.message;
            btn.innerText = "Login & Initialize";
        }
    }

    /* =========================================
       PART 2: SIP.JS (THE SOFTPHONE)
       ========================================= */
    function initializeSoftphone(sipUser, sipPass, domain) {
        const transportOptions = {
            server: `wss://${domain}:8089` // Standard NetSapiens WSS Port
        };

        const uri = SIP.UserAgent.makeURI(`sip:${sipUser}@${domain}`);
        
        userAgent = new SIP.UserAgent({
            uri: uri,
            transportOptions: transportOptions,
            authorizationUsername: sipUser,
            authorizationPassword: sipPass,
            delegate: {
                onConnect: () => {
                    document.getElementById('sip-led').classList.add('on');
                    document.getElementById('sip-status').innerText = "Phone Ready";
                },
                onDisconnect: (error) => {
                    document.getElementById('sip-led').classList.remove('on');
                    document.getElementById('sip-status').innerText = "Disconnected";
                }
            }
        });

        userAgent.start();
    }

    /* =========================================
       PART 3: DIALER LOGIC
       ========================================= */
    function renderLeads() {
        const list = document.getElementById('leads-list');
        list.innerHTML = leads.map((l, i) => 
            `<div class="lead-row" id="row-${i}">
                <span>${l.Name}</span>
                <small>${l.Phone}</small>
             </div>`
        ).join('');
    }

    async function startPowerDialer() {
        isDialing = true;
        for (let i = 0; i < leads.length; i++) {
            if (!isDialing) break;
            
            document.querySelectorAll('.lead-row').forEach(r => r.classList.remove('active'));
            document.getElementById(`row-${i}`).classList.add('active');
            
            await placeCall(leads[i].Phone);
            
            // Wait 5 seconds between calls
            await new Promise(r => setTimeout(r, 5000));
        }
    }

    function stopPowerDialer() { isDialing = false; }

    async function manualCall() {
        const num = document.getElementById('manual-dial').value;
        if(num) placeCall(num);
    }

    function placeCall(number) {
        return new Promise((resolve) => {
            console.log("Dialing:", number);
            document.getElementById('sip-status').innerText = `Dialing ${number}...`;
            
            const target = SIP.UserAgent.makeURI(`sip:${number}@${userAgent.configuration.uri.host}`);
            const inviter = new SIP.Inviter(userAgent, target);
            
            inviter.stateChange.addListener((state) => {
                console.log("Call State:", state);
                if (state === SIP.SessionState.Terminated) {
                    document.getElementById('sip-status').innerText = "Call Ended";
                    resolve(); 
                }
            });

            inviter.invite();
        });
    }

    ZOHO.embeddedApp.init();
</script>
</body>
</html>
